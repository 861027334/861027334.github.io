<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" href="css/swiper.min.css">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div id="top">
    <div class="swiper-container" id="nav">
        <div class="swiper-wrapper">
            <div class="swiper-slide">
                <span style="color: rgba(221,169,68,1);">热卖</span></div>
            <div class="swiper-slide">
                <span>水果</span></div>
            <div class="swiper-slide">
                <span>乳品</span></div>
            <div class="swiper-slide">
                <span>乳品</span></div>
            <div class="bar">
                <div class="color"></div>
            </div>
        </div>
    </div>
</div>
<div class="swiper-container" id="page">
    <div class="swiper-wrapper">
        <div class="swiper-slide slidepage">
            <div class="swiper-container scroll">
                <div class="swiper-wrapper">
                    <div class="swiper-slide slidescroll" style="background-color: red">
                        <p>1</p>
                        <p>2</p>
                        <p>3</p>
                        <p>4</p>
                        <p>5</p>
                        <p>6</p>
                        <p>7</p>
                        <p>8</p>
                        <p>9</p>
                        <p>10</p>
                        <p>11</p>
                        <p>12</p>
                        <p>13</p>
                        <p>14</p>
                        <p>15</p>
                        <p>16</p>
                        <p>17</p>
                        <p>18</p>
                        <p>19</p>
                        <p>20</p>
                        <p>21</p>
                        <p>22</p>
                        <p>23</p>
                        <p>24</p>
                        <p>25</p>
                        <p>26</p>
                        <p>27</p>
                        <p>28</p>
                        <p>29</p>
                        <p>30</p>
                        <p>31</p>
                        <p>32</p>
                        <p>33</p>
                        <p>34</p>
                        <p>35</p>
                        <p>36</p>
                        <p>37</p>
                        <p>38</p>
                        <p>39</p>
                        <p>40</p>
                        <p>41</p>
                        <p>42</p>
                        <p>43</p>
                        <p>44</p>
                        <p>45</p>
                        <p>46</p>
                        <p>47</p>
                        <p>48</p>
                        <p>49</p>
                        <p>50</p>
                        <p>51</p>
                        <p>52</p>
                        <p>53</p>
                        <p>54</p>
                        <p>55</p>
                        <p>56</p>
                        <p>57</p>
                        <p>58</p>
                        <p>59</p>
                        <p>60</p>
                        <p>61</p>
                        <p>62</p>
                        <p>63</p>
                        <p>64</p>
                        <p>65</p>
                        <p>66</p>
                        <p>67</p>
                        <p>68</p>
                        <p>69</p>
                        <p>70</p>
                        <p>71</p>
                        <p>72</p>
                        <p>73</p>
                        <p>74</p>
                        <p>75</p>
                        <p>76</p>
                        <p>77</p>
                        <p>78</p>
                        <p>79</p>
                        <p>80</p>
                        <p>81</p>
                        <p>82</p>
                        <p>83</p>
                        <p>84</p>
                        <p>85</p>
                        <p>86</p>
                        <p>87</p>
                        <p>88</p>
                        <p>89</p>
                        <p>90</p>
                        <p>91</p>
                        <p>92</p>
                        <p>93</p>
                        <p>94</p>
                        <p>95</p>
                        <p>96</p>
                        <p>97</p>
                        <p>98</p>
                        <p>99</p>
                        <p>100</p>
                        <p>101</p>
                        <p>102</p>
                        <p>103</p>
                        <p>104</p>
                        <p>105</p>
                        <p>106</p>
                        <p>107</p>
                        <p>108</p>
                        <p>109</p>
                        <p>110</p>
                        <p>111</p>
                        <p>112</p>
                        <p>113</p>
                        <p>114</p>
                        <p>115</p>
                        <p>116</p>
                        <p>117</p>
                        <p>118</p>
                        <p>119</p>
                        <p>120</p>
                        <p>121</p>
                        <p>122</p>
                        <p>123</p>
                        <p>124</p>
                        <p>125</p>
                        <p>126</p>
                        <p>127</p>
                        <p>128</p>
                        <p>129</p>
                        <p>130</p>
                        <p>131</p>
                        <p>132</p>
                        <p>133</p>
                        <p>134</p>
                        <p>135</p>
                        <p>136</p>
                        <p>137</p>
                        <p>138</p>
                        <p>139</p>
                        <p>140</p>
                        <p>141</p>
                        <p>142</p>
                        <p>143</p>
                        <p>144</p>
                        <p>145</p>
                        <p>146</p>
                        <p>147</p>
                        <p>148</p>
                        <p>149</p>
                        <p>150</p>
                        <p>151</p>
                        <p>152</p>
                        <p>153</p>
                        <p>154</p>
                        <p>155</p>
                        <p>156</p>
                        <p>157</p>
                        <p>158</p>
                        <p>159</p>
                        <p>160</p>
                        <p>161</p>
                        <p>162</p>
                        <p>163</p>
                        <p>164</p>
                        <p>165</p>
                        <p>166</p>
                        <p>167</p>
                        <p>168</p>
                        <p>169</p>
                        <p>170</p>
                        <p>171</p>
                        <p>172</p>
                        <p>173</p>
                        <p>174</p>
                        <p>175</p>
                        <p>176</p>
                        <p>177</p>
                        <p>178</p>
                        <p>179</p>
                        <p>180</p>
                        <p>181</p>
                        <p>182</p>
                        <p>183</p>
                        <p>184</p>
                        <p>185</p>
                        <p>186</p>
                        <p>187</p>
                        <p>188</p>
                        <p>189</p>
                        <p>190</p>
                        <p>191</p>
                        <p>192</p>
                        <p>193</p>
                        <p>194</p>
                        <p>195</p>
                        <p>196</p>
                        <p>197</p>
                        <p>198</p>
                        <p>199</p>
                        <p>200</p>
                    </div></div>
            </div>
        </div>
        <div class="swiper-slide slidepage">
            <div class="swiper-container scroll">
                <div class="swiper-wrapper">
                    <div class="swiper-slide slidescroll">slide2</div></div>
            </div>
        </div>
        <div class="swiper-slide slidepage">
            <div class="swiper-container scroll">
                <div class="swiper-wrapper">
                    <div class="swiper-slide slidescroll">slide3</div></div>
            </div>
        </div>
        <div class="swiper-slide slidepage">
            <div class="swiper-container scroll">
                <div class="swiper-wrapper">
                    <div class="swiper-slide slidescroll">slide3</div></div>
            </div>
        </div>
    </div>
</div>
<script src="js/swiper.min.js"></script>
<script>
    //暂时设计每个slide大小需要一致
    tSpeed = 300 //切换速度300ms
    var navSwiper = new Swiper('#nav', {
        slidesPerView: 3,
        freeMode: true,
        on: {
            init: function() {
                navSlideWidth = this.slides.eq(0).css('width'); //导航字数需要统一,每个导航宽度一致
                bar = this.$el.find('.bar')
                bar.css('width', navSlideWidth)
                bar.transition(tSpeed)
                navSum = this.slides[this.slides.length - 1].offsetLeft //最后一个slide的位置

                clientWidth = parseInt(this.$wrapperEl.css('width')) //Nav的可视宽度
                navWidth = 0
                for (i = 0; i < this.slides.length; i++) {
                    navWidth += parseInt(this.slides.eq(i).css('width'))
                }

                topBar = this.$el.parents('body').find('#top') //页头

            },

        },
    });

    var pageSwiper = new Swiper('#page', {
        watchSlidesProgress: true,
        // resistanceRatio: 0,
        on: {
            touchMove: function() {
                progress = this.progress
                bar.transition(0)
                bar.transform('translateX(' + navSum * progress + 'px)')
            },
            transitionStart: function() {
                activeIndex = this.activeIndex
                activeSlidePosition = navSwiper.slides[activeIndex].offsetLeft
                //释放时导航粉色条移动过渡
                bar.transition(tSpeed)
                bar.transform('translateX(' + activeSlidePosition + 'px)')
                //释放时文字变色过渡
                navSwiper.slides.eq(activeIndex).find('span').transition(tSpeed)
                navSwiper.slides.eq(activeIndex).find('span').css('color', 'rgba(221,169,68,1)')
                if (activeIndex > 0) {
                    navSwiper.slides.eq(activeIndex - 1).find('span').transition(tSpeed)
                    navSwiper.slides.eq(activeIndex - 1).find('span').css('color', 'rgba(124,124,125,1)')
                }
                if (activeIndex < this.slides.length) {
                    navSwiper.slides.eq(activeIndex + 1).find('span').transition(tSpeed)
                    navSwiper.slides.eq(activeIndex + 1).find('span').css('color', 'rgba(124,124,125,1)')
                }
                //导航居中
                navActiveSlideLeft = navSwiper.slides[activeIndex].offsetLeft //activeSlide距左边的距离

                navSwiper.setTransition(tSpeed)
                if (navActiveSlideLeft < (clientWidth - parseInt(navSlideWidth)) / 2) {
                    navSwiper.setTranslate(0)
                } else if (navActiveSlideLeft > navWidth - (parseInt(navSlideWidth) + clientWidth) / 2) {
                    navSwiper.setTranslate(clientWidth - navWidth)
                } else {
                    navSwiper.setTranslate((clientWidth - parseInt(navSlideWidth)) / 2 - navActiveSlideLeft)
                }

            },
        }
    });

    navSwiper.$el.on('touchstart', function(e) {
        e.preventDefault() //去掉按压阴影
    })
    navSwiper.on('tap', function(e) {

        clickIndex = this.clickedIndex
        clickSlide = this.slides.eq(clickIndex)
        pageSwiper.slideTo(clickIndex, 0);
        this.slides.find('span').css('color', 'rgba(124,124,125,1)');
        clickSlide.find('span').css('color', 'rgba(221,169,68,1)');
    })


    var topbarHeight = document.getElementById('top').clientHeight;
    console.log(topbarHeight);
    var offsetTop = 0;
    //内容滚动
    var scrollSwiper = new Swiper('.scroll', {
        //65是头部的高
        //36是top地址和搜索的高

        slidesOffsetBefore: topbarHeight,
        direction: 'vertical',
        freeMode: true,
        slidesPerView: 'auto',
        // autoHeight:true,

        mousewheel: {
            releaseOnEdges: true,
        },
        on: {
            touchMove: function() {

                if (this.translate > topbarHeight - offsetTop && this.translate < topbarHeight) {
                    topBar.transform('translateY(' + (this.translate - topbarHeight) + 'px)');
                }

            },
            touchStart: function() {
                startPosition = this.translate
            },
            touchEnd: function() {
                topBar.transition(tSpeed)
                if (this.translate > offsetTop && this.translate < topbarHeight && this.translate < startPosition) {
                    topBar.transform('translateY(-'+offsetTop+'px)');
                    for (sc = 0; sc < scrollSwiper.length; sc++) {
                        if (scrollSwiper[sc].translate > offsetTop) {
                            scrollSwiper[sc].setTransition(tSpeed);
                            scrollSwiper[sc].setTranslate(offsetTop)
                        }
                    }
                }
                if (this.translate > offsetTop && this.translate < topbarHeight && this.translate > startPosition) {
                    topBar.transform('translateY(0px)');
                    for (sc = 0; sc < scrollSwiper.length; sc++) {
                        if (scrollSwiper[sc].translate < topbarHeight && scrollSwiper[sc].translate > 0) {
                            scrollSwiper[sc].setTransition(tSpeed);
                            scrollSwiper[sc].setTranslate(topbarHeight)
                        }
                    }

                }
            },

            transitionStart: function() {
                topBar.transition(tSpeed)
                if (this.translate < topbarHeight - offsetTop) {
                    topBar.transform('translateY(-'+offsetTop+'px)');
                    if (scrollSwiper) {
                        for (sc = 0; sc < scrollSwiper.length; sc++) {
                            if (scrollSwiper[sc].translate > offsetTop) {
                                scrollSwiper[sc].setTransition(tSpeed);
                                scrollSwiper[sc].setTranslate(offsetTop)
                            }
                        }
                    }

                } else {
                    topBar.transform('translateY(0px)');
                    if (scrollSwiper) {
                        for (sc = 0; sc < scrollSwiper.length; sc++) {
                            if (scrollSwiper[sc].translate < topbarHeight && scrollSwiper[sc].translate > 0) {
                                scrollSwiper[sc].setTransition(tSpeed);
                                scrollSwiper[sc].setTranslate(topbarHeight)
                            }
                        }
                    }
                }
            },
        }

    })
</script>
</body>
</html>